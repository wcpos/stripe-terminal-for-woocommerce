!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.StripeTerminalPayment=t():e.StripeTerminalPayment=t()}(this,()=>(()=>{"use strict";var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>s});class r{constructor(){this.isInitialized=!1,this.currentPaymentIntent=null,this.connectedReader=null,this.pollingInterval=null,this.isDeclined=!1,this.config=window.stripeTerminalData||{},this.ajaxUrl=this.config.ajaxUrl||window.ajaxurl||"/wp-admin/admin-ajax.php",this.nonce=this.config.nonce||"",this.strings=this.config.strings||{},this.readers=this.config.readers||[],this.init()}init(){this.bindEvents(),this.initializeInterface(),this.isInitialized=!0}bindEvents(){jQuery(document).on("click",".stripe-terminal-pay-button",this.handlePayment.bind(this)),jQuery(document).on("click",".stripe-terminal-cancel-button",this.handleCancel.bind(this)),jQuery(document).on("click",".stripe-terminal-simulate-button",this.handleSimulatePayment.bind(this)),jQuery(document).on("click",".stripe-terminal-check-status-button",this.handleCheckStatus.bind(this)),jQuery(document).on("click",".stripe-terminal-retry-button",this.handleRetryPayment.bind(this)),jQuery(document).on("click",".stripe-terminal-connect-button",this.handleConnectReader.bind(this)),jQuery(document).on("click",".stripe-terminal-disconnect-button",this.handleDisconnectReader.bind(this)),jQuery(document).on("click",".stripe-terminal-toggle-log",this.handleToggleLog.bind(this)),jQuery(document).on("click",".stripe-terminal-clear-log",this.handleClearLog.bind(this))}async handlePayment(e){if(e.preventDefault(),!this.isInitialized)return void this.showError(this.strings.systemNotInitialized||"Payment system not initialized");if(!this.connectedReader)return void this.showError(this.strings.selectReader||"Please select a reader to continue");const t=jQuery(e.target),r=t.data("order-id")||this.config.orderId,s=t.data("amount");if(r&&s)try{t.prop("disabled",!0).text(this.strings.startingPayment||"Starting payment...");const e=await this.createPaymentIntent(r,s);if(!e||!e.payment_intent||!e.payment_intent.id)throw new Error("Failed to create payment intent");this.currentPaymentIntent=e.payment_intent,t.text(this.strings.paymentInProgress||"Payment in progress..."),this.updateButtonVisibility(),this.showMessage(this.strings.useTerminal||"Please use the terminal to complete the payment"),this.pollPaymentStatus(this.currentPaymentIntent.id,r,t)}catch(e){this.showError((this.strings.paymentFailed||"Payment failed")+": "+e.message),t.prop("disabled",!1).text(this.strings.payWithTerminal||"Pay with Terminal")}else this.showError(this.strings.missingData||"Missing order ID or amount")}async createPaymentIntent(e,t){return new Promise((r,s)=>{const i={action:"stripe_terminal_create_payment_intent",order_id:e,amount:t,reader_id:this.connectedReader.id};this.config.orderKey&&(i.order_key=this.config.orderKey),jQuery.ajax({url:this.ajaxUrl,type:"POST",data:i,success:e=>{e.success?r(e.data):s(new Error(e.data||"Failed to create payment intent"))},error:(e,t,r)=>{let i="AJAX error: "+r;try{const t=JSON.parse(e.responseText);t.data&&t.data.message?i=t.data.message:t.data&&(i=t.data)}catch(e){}s(new Error(i))}})})}async confirmPayment(e,t){return new Promise((r,s)=>{const i={action:"stripe_terminal_confirm_payment",payment_intent_id:e,order_id:t};this.config.orderKey&&(i.order_key=this.config.orderKey),jQuery.ajax({url:this.ajaxUrl,type:"POST",data:i,success:e=>{e.success?r(e.data):s(new Error(e.data||"Failed to confirm payment"))},error:(e,t,r)=>{let i="AJAX error: "+r;try{const t=JSON.parse(e.responseText);t.data&&t.data.message?i=t.data.message:t.data&&(i=t.data)}catch(e){}s(new Error(i))}})})}async cancelPayment(e,t){return new Promise((r,s)=>{const i={action:"stripe_terminal_cancel_payment",payment_intent_id:e,order_id:t};this.config.orderKey&&(i.order_key=this.config.orderKey),jQuery.ajax({url:this.ajaxUrl,type:"POST",data:i,success:e=>{e.success?r(e.data):s(new Error(e.data||"Failed to cancel payment"))},error:(e,t,r)=>{let i="AJAX error: "+r;try{const t=JSON.parse(e.responseText);t.data&&t.data.message?i=t.data.message:t.data&&(i=t.data)}catch(e){}s(new Error(i))}})})}pollPaymentStatus(e,t,r){this.stopPolling(),this.pollingInterval=setInterval(async()=>{try{const e=await jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_check_payment_status",order_id:t,order_key:this.config.orderKey}});if(e.success){const t=e.data;t.is_paid?(this.stopPolling(),this.handleSuccessfulPayment(t)):"requires_payment_method"===t.payment_intent_status&&t.last_payment_error?(this.stopPolling(),this.handleDecline(t,r)):"failed"!==t.status&&"cancelled"!==t.status||(this.stopPolling(),this.showError(this.strings.paymentFailed||"Payment failed"),r.prop("disabled",!1).text(this.strings.payWithTerminal||"Pay with Terminal"),this.currentPaymentIntent=null,this.isDeclined=!1,this.updateButtonVisibility())}}catch(e){}},2e3),setTimeout(()=>{this.stopPolling(),r.prop("disabled")&&(this.showError(this.strings.paymentTimeout||"Payment timed out"),r.prop("disabled",!1).text(this.strings.payWithTerminal||"Pay with Terminal"),this.currentPaymentIntent=null,this.isDeclined=!1,this.updateButtonVisibility())},3e5)}handleDecline(e,t){const r=e.last_payment_error.message||this.strings.cardDeclined||"Card declined";this.showError(r),this.addToLog("Card declined: "+r,"warning"),this.isDeclined=!0,t.text(this.strings.payWithTerminal||"Pay with Terminal"),t.prop("disabled",!0),this.updateButtonVisibility()}handleRetryPayment(e){if(e.preventDefault(),!this.currentPaymentIntent||!this.currentPaymentIntent.id)return void this.showError("No active payment to retry");if(!this.connectedReader)return void this.showError(this.strings.selectReader||"Please select a reader to continue");const t=jQuery(e.target),r=t.data("order-id")||this.config.orderId,s=jQuery(".stripe-terminal-pay-button");t.prop("disabled",!0).text("Retrying..."),this.isDeclined=!1,jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_retry_payment",order_id:r,reader_id:this.connectedReader.id,order_key:this.config.orderKey}}).done(e=>{e.success?(this.addToLog("Payment retry sent to reader. Present a new card.","info"),this.showMessage(this.strings.useTerminal||"Please use the terminal to complete the payment"),s.text(this.strings.paymentInProgress||"Payment in progress..."),this.updateButtonVisibility(),this.pollPaymentStatus(this.currentPaymentIntent.id,r,s)):(this.showError("Retry failed: "+(e.data||"Unknown error")),this.isDeclined=!0,this.updateButtonVisibility()),t.prop("disabled",!1).text(this.strings.tryAnotherCard||"Try Another Card")}).fail((e,r,s)=>{this.showError("Retry failed: "+s),t.prop("disabled",!1).text(this.strings.tryAnotherCard||"Try Another Card"),this.isDeclined=!0,this.updateButtonVisibility()})}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}handleCancel(e){if(e.preventDefault(),this.stopPolling(),this.currentPaymentIntent&&this.currentPaymentIntent.id){const e=this.config.orderId;this.cancelPayment(this.currentPaymentIntent.id,e).then(()=>{this.showMessage(this.strings.paymentCancelled||"Payment cancelled"),this.currentPaymentIntent=null,this.isDeclined=!1,jQuery(".stripe-terminal-pay-button").prop("disabled",!1).text(this.strings.payWithTerminal||"Pay with Terminal"),this.updateButtonVisibility()}).catch(e=>{this.showError("Error cancelling payment: "+e.message)})}else this.showMessage(this.strings.noActivePayment||"No active payment to cancel")}handleSimulatePayment(e){e.preventDefault();const t=jQuery(e.target),r=t.data("order-id")||this.config.orderId;r?this.connectedReader?(t.prop("disabled",!0).text("Simulating..."),jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_simulate_payment",reader_id:this.connectedReader.id,order_id:r,order_key:this.config.orderKey}}).done(e=>{if(e.success){const r=e.data;this.showSuccess("Payment simulation triggered! Payment Intent: "+r.payment_intent+". Check the terminal reader."),t.prop("disabled",!1).text("Simulate Payment"),this.currentPaymentIntent={id:r.payment_intent},this.updateButtonVisibility()}else this.showError("Simulation failed: "+(e.data||"Unknown error")),t.prop("disabled",!1).text("Simulate Payment")}).fail((e,r,s)=>{this.showError("Simulation failed: "+s),t.prop("disabled",!1).text("Simulate Payment")})):this.showError("Please connect to a reader first"):this.showError("Missing order ID for simulation")}handleCheckStatus(e){e.preventDefault();const t=jQuery(e.target),r=t.data("order-id")||this.config.orderId;r?(t.prop("disabled",!0).text("Checking..."),this.addToLog("Checking payment status with Stripe...","info"),jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_check_stripe_status",order_id:r,order_key:this.config.orderKey}}).done(e=>{if(e.success){const t=e.data;this.addToLog("Payment status check completed","info"),t.payment_found&&t.payment_successful?(this.addToLog("Successful payment found! Processing order...","success"),this.showSuccess("Payment found! Processing order..."),this.handleSuccessfulPayment(t)):t.payment_found&&!t.payment_successful?(this.addToLog("Payment found but not successful: "+(t.payment_status||"unknown"),"warning"),this.showMessage("Payment found but not successful: "+(t.payment_status||"unknown"))):(this.addToLog("No payment found for this order","info"),this.showMessage("No payment found for this order"))}else this.addToLog("Status check failed: "+(e.data||"Unknown error"),"error"),this.showError("Status check failed: "+(e.data||"Unknown error"))}).fail((e,t,r)=>{this.addToLog("Status check error: "+r,"error"),this.showError("Status check error: "+r)}).always(()=>{t.prop("disabled",!1).text("Check Payment Status")})):this.showError("Missing order ID")}handleSuccessfulPayment(e){const t=jQuery("#place_order");if(t.length>0)return this.showSuccess("Payment successful! Processing order..."),void t.click();const r=jQuery("#order_review");if(r.length>0)return this.showSuccess("Payment successful! Processing order..."),void r.submit();const s=jQuery('form.checkout, form[name="checkout"]');if(s.length>0)return this.showSuccess("Payment successful! Processing order..."),void s.submit();const i=jQuery("form").first();i.length>0?(this.showSuccess("Payment successful! Processing order..."),i.submit()):(this.showSuccess("Payment successful! Please refresh the page to continue."),e.return_url&&setTimeout(()=>{window.location.href=e.return_url},2e3))}handlePaymentSuccess(e){this.stopPolling(),this.currentPaymentIntent=null,this.updateButtonVisibility(),jQuery(document).trigger("stripe_terminal_payment_success",[e]),"undefined"!=typeof wc_checkout_params&&jQuery(document.body).trigger("checkout_error",[{message:"Payment successful, redirecting..."}])}showError(e){this.showStatusMessage(e,"error")}showSuccess(e){this.showStatusMessage(e,"success")}showMessage(e){this.showStatusMessage(e,"info")}showStatusMessage(e,t="info"){if(this.addToLog(e,t),"error"===t){jQuery(".stripe-terminal-error, .stripe-terminal-success, .stripe-terminal-info").hide();const t=jQuery(".stripe-terminal-error");t.length>0&&(t.find("p").text(e),t.show())}}addToLog(e,t="info"){const r=jQuery(".stripe-terminal-log-textarea");if(r.length>0){const s=`[${(new Date).toLocaleTimeString()}] ${t.toUpperCase().padEnd(8)} ${e}\n`;r.val(r.val()+s),r.scrollTop(r[0].scrollHeight)}}async getReaderStatus(){try{const e=await jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_get_reader_status",nonce:this.nonce}});if(e.success)return e.data;throw new Error(e.data||"Failed to get reader status")}catch(e){return null}}async initializeInterface(){try{this.showLoading();if(!await this.validateService())return void this.showServiceError();const e=await this.fetchReaders();if(null===e)return void this.showReadersError();this.readers=e,this.showInterface(),this.loadSavedReader()}catch(e){this.showServiceError()}}async validateService(){try{return(await jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_validate_service"}})).success}catch(e){return!1}}async fetchReaders(){try{const e=await jQuery.ajax({url:this.ajaxUrl,type:"POST",data:{action:"stripe_terminal_get_readers"}});return e.success?e.data.readers:null}catch(e){return null}}showLoading(){jQuery(".stripe-terminal-loading").show(),jQuery(".stripe-terminal-payment-section").hide()}showServiceError(){jQuery(".stripe-terminal-loading").hide(),jQuery(".stripe-terminal-payment-section").hide(),jQuery(".stripe-terminal-error").show().find("p").text(this.strings.serviceError||"Service error")}showReadersError(){jQuery(".stripe-terminal-loading").hide(),jQuery(".stripe-terminal-payment-section").show(),jQuery(".stripe-terminal-error").show().find("p").text(this.strings.readersError||"Failed to load readers")}showInterface(){jQuery(".stripe-terminal-loading").hide(),jQuery(".stripe-terminal-payment-section").show(),jQuery(".stripe-terminal-error").hide(),setTimeout(()=>{this.populateReaders(),this.updateReaderUI()},100)}populateReaders(){const e=jQuery(".stripe-terminal-readers-list"),t=jQuery(".stripe-terminal-readers-section");0!==e.length&&(e.empty(),0!==this.readers.length?(this.readers.forEach((t,r)=>{const s=this.createReaderCard(t);e.append(s)}),t.show()):t.hide())}createReaderCard(e){const t=e.id||"",r=e.label||t,s=e.device_type||"unknown",i=e.status||"unknown",n=e.serial_number||"",a=e.last_seen_at||null;let o="";if(a){const e=new Date(1e3*a);o=`Last seen: ${this.timeAgo(e)}`}return jQuery(`\n      <div class="stripe-terminal-reader-card" data-reader-id="${t}">\n        <div class="stripe-terminal-reader-header">\n          <h5 class="stripe-terminal-reader-label">${r}</h5>\n          <span class="stripe-terminal-reader-status ${"online"===i?"online":"offline"}">${"online"===i?"Online":"Offline"}</span>\n        </div>\n        <div class="stripe-terminal-reader-details">\n          <p><strong>Device:</strong> ${s}</p>\n          ${n?`<p><strong>Serial:</strong> ${n}</p>`:""}\n          ${o?`<p><strong>${o}</strong></p>`:""}\n        </div>\n        <div class="stripe-terminal-reader-actions">\n          ${"online"===i?`<button type="button" class="stripe-terminal-connect-button" data-reader-id="${t}">Connect</button>`:'<button type="button" class="stripe-terminal-connect-button" disabled>Offline</button>'}\n        </div>\n      </div>\n    `)}timeAgo(e){const t=new Date,r=Math.floor((t-e)/1e3);return r<60?"just now":r<3600?`${Math.floor(r/60)} minutes ago`:r<86400?`${Math.floor(r/3600)} hours ago`:`${Math.floor(r/86400)} days ago`}loadSavedReader(){const e=localStorage.getItem("stripe_terminal_reader_id");if(e){const t=this.readers.find(t=>t.id===e);t&&"online"===t.status?this.connectReader(t):localStorage.removeItem("stripe_terminal_reader_id")}}saveReader(e){localStorage.setItem("stripe_terminal_reader_id",e)}clearSavedReader(){localStorage.removeItem("stripe_terminal_reader_id")}handleConnectReader(e){e.preventDefault();const t=jQuery(e.target).data("reader-id");if(!t)return void this.showError("Invalid reader ID");const r=this.readers.find(e=>e.id===t);r?"online"===r.status?this.connectReader(r):this.showError("Reader is offline"):this.showError("Reader not found")}connectReader(e){this.connectedReader=e,this.saveReader(e.id),this.updateReaderUI(),this.showSuccess(`${this.strings.connected||"Connected"} to ${e.label||e.id}`)}handleDisconnectReader(e){e.preventDefault(),this.disconnectReader()}disconnectReader(){if(this.connectedReader){const e=this.connectedReader.label||this.connectedReader.id;this.connectedReader=null,this.clearSavedReader(),this.updateReaderUI(),this.showSuccess(`${this.strings.disconnected||"Disconnected"} from ${e}`)}}updateReaderUI(){const e=jQuery(".stripe-terminal-readers-section"),t=jQuery(".stripe-terminal-connected-reader"),r=jQuery(".stripe-terminal-payment-buttons");if(this.connectedReader){e.hide(),t.show(),r.show();const s=this.connectedReader;jQuery(".stripe-terminal-reader-details").html(`\n        <p><strong>${s.label||s.id}</strong></p>\n        <p>Device: ${s.device_type||"Unknown"}</p>\n        <p>Status: <span class="status-${s.status||"offline"}">${"online"===s.status?"Online":"Offline"}</span></p>\n        ${s.serial_number?`<p>Serial: ${s.serial_number}</p>`:""}\n      `),this.updateButtonVisibility()}else e.show(),t.hide(),r.hide()}getConnectedReaderId(){return this.connectedReader?this.connectedReader.id:null}handleToggleLog(e){e.preventDefault();const t=jQuery(e.target),r=jQuery(".stripe-terminal-log-content");!0===t.data("expanded")?(r.slideUp(),t.text("Show Log").data("expanded",!1)):(r.slideDown(),t.text("Hide Log").data("expanded",!0))}updateButtonVisibility(){if(!this.connectedReader)return;const e=jQuery(".stripe-terminal-simulate-button"),t=jQuery(".stripe-terminal-cancel-button"),r=jQuery(".stripe-terminal-retry-button");this.connectedReader.device_type&&this.connectedReader.device_type.includes("simulated")&&this.currentPaymentIntent&&!this.isDeclined?e.show():e.hide(),this.currentPaymentIntent?t.show():t.hide(),this.isDeclined&&this.currentPaymentIntent?r.show():r.hide()}handleClearLog(e){e.preventDefault();const t=jQuery(".stripe-terminal-log-textarea");t.length>0&&t.val("")}}jQuery(document).ready(function(){window.stripeTerminalPayment=new r});const s=r;return t=t.default})());